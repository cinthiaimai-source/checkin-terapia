<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cl√≠nica ‚Äî Check-in (Pacientes + Importa√ß√£o)</title>
  <style>
    :root{
      --bg:#f6f9ff; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --shadow:0 12px 30px rgba(15,23,42,.08); --radius:16px;
      --blue:#2563eb; --violet:#8b5cf6; --emerald:#10b981; --amber:#f59e0b; --rose:#f43f5e;
      --softBlue:#eff6ff; --softViolet:#f5f3ff; --softGreen:#ecfdf5; --softRose:#fff1f2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, #dbeafe 0%, transparent 60%),
        radial-gradient(900px 500px at 85% 15%, #ede9fe 0%, transparent 55%),
        radial-gradient(1000px 600px at 40% 95%, #dcfce7 0%, transparent 60%),
        var(--bg);
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 16px 46px;}
    header{display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start}
    .title{display:flex; gap:12px; align-items:flex-start}
    .badge{
      width:46px; height:46px; border-radius:16px;
      background: linear-gradient(135deg, var(--blue), var(--violet));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      color:white; font-weight:900; font-size:18px;
    }
    h1{margin:0; font-size:20px;}
    .sub{margin:6px 0 0; color:var(--muted); line-height:1.4; max-width:820px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-top:12px;
    }
    .layout{display:grid; grid-template-columns: 360px 1fr; gap:12px; align-items:start;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
    label{font-size:12px; color:var(--muted)}
    input[type="text"], input[type="date"], input[type="tel"], textarea{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border);
      outline:none; background:white;
    }
    input:focus, textarea:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    textarea{min-height:88px; resize:vertical}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:0; border-radius:12px; padding:10px 12px;
      font-weight:900; cursor:pointer;
      box-shadow: 0 10px 18px rgba(15,23,42,.08);
    }
    .primary{background:linear-gradient(135deg,var(--blue),var(--violet)); color:white}
    .ghost{background:white; border:1px solid var(--border); color:var(--text); box-shadow:none}
    .ok{background:linear-gradient(135deg,var(--emerald),#22c55e); color:#052e1b}
    .warn{background:linear-gradient(135deg,var(--amber),#fb7185); color:#111827}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    /* Patient list */
    .pActive{
      margin-top:10px; padding:12px; border:1px solid var(--border); border-radius:14px;
      background: linear-gradient(135deg, var(--softBlue), #ffffff);
    }
    .pActive .name{font-weight:1000}
    .pActive .meta{color:var(--muted); font-size:12px; margin-top:4px}
    .pList{margin-top:10px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:white;}
    .pRow{display:flex; justify-content:space-between; gap:10px; padding:10px; border-bottom:1px solid var(--border); cursor:pointer;}
    .pRow:last-child{border-bottom:none}
    .pRow:hover{background:#fbfdff}
    .pRow .nm{font-weight:1000; line-height:1.1}
    .pRow .id{font-size:12px; color:var(--muted)}
    .tag{
      font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:white; white-space:nowrap;
    }
    .tag.active{background:linear-gradient(135deg,var(--blue),var(--violet)); color:white; border-color:transparent}

    /* Tabs */
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .tab{
      border:1px solid var(--border); background:white; color:var(--text);
      box-shadow:none; font-weight:1000; border-radius:999px; padding:10px 12px;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    }
    .tab.active{
      background: linear-gradient(135deg, var(--blue), var(--violet));
      color:white; border-color: transparent; box-shadow: 0 10px 18px rgba(15,23,42,.08);
    }
    .ico{
      width:22px; height:22px; border-radius:8px; display:grid; place-items:center;
      background: rgba(255,255,255,.25); border: 1px solid rgba(255,255,255,.2);
      font-size:12px; font-weight:1000;
    }
    .tab:not(.active) .ico{background: var(--softBlue); border:1px solid #dbeafe; color:#0b1b44}

    /* Q blocks */
    .q{border:1px solid var(--border); border-radius:14px; padding:14px; background: linear-gradient(180deg, #fff, #fbfdff);}
    .qhead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .qnum{width:34px; height:34px; border-radius:12px; display:grid; place-items:center; font-weight:1000;
      background: var(--softBlue); border:1px solid #dbeafe; flex:0 0 auto;}
    .qtitle{font-weight:1000; margin:0}
    .qtext{margin:8px 0 10px; color:var(--muted); line-height:1.45}
    .choices{display:grid; gap:8px}
    .choice{display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px solid var(--border); border-radius:12px; background:white;}
    .choice input{margin-top:2px}

    .grid{display:grid; gap:12px}
    .two{display:grid; grid-template-columns: 1.15fr .85fr; gap:12px; margin-top:12px;}
    @media (max-width: 980px){ .two{grid-template-columns:1fr} }

    .scorebar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:12px; border:1px solid var(--border); border-radius: 14px;
      background: linear-gradient(135deg, var(--softViolet), #ffffff);
      margin-top:12px;
    }
    .score .big{font-size:24px; font-weight:1000}
    .pill{
      padding:8px 10px; border-radius:999px; border:1px solid var(--border);
      background:white; font-weight:900; display:inline-flex; gap:8px; align-items:center; max-width:620px;
    }
    .pill i{width:10px; height:10px; border-radius:999px; background:var(--blue); display:inline-block}

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 720px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{border:1px solid var(--border); border-radius:14px; padding:12px; background:white;}
    .kpi .box .v{font-size:18px; font-weight:1000}
    .kpi .box .t{font-size:12px; color:var(--muted)}
    canvas{width:100%; height:320px; background:white; border:1px solid var(--border); border-radius:14px}
    .minihelp{font-size:12px; color:var(--muted); line-height:1.4; background:linear-gradient(135deg, var(--softGreen), #fff);
      border:1px solid var(--border); border-radius:14px; padding:12px; margin-top:10px;}
    .tablewrap{overflow:auto; border:1px solid var(--border); border-radius:14px}
    table{width:100%; border-collapse:collapse; min-width:900px; background:white}
    th, td{padding:10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top}
    th{font-size:12px; color:var(--muted); background:#fbfdff}
    .right{text-align:right}

    .emotionLine{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
      margin: 4px 0 10px;
      padding:10px;
      border:1px dashed #cbd5e1;
      border-radius:14px;
      background: linear-gradient(135deg, #ffffff, var(--softRose));
    }
    .divider{height:1px; background:var(--border); margin:12px 0}

    /* New: message box to send patient */
    .sendBox{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: linear-gradient(135deg, var(--softGreen), #ffffff);
      margin-top:12px;
    }
    .sendTitle{font-weight:1000; margin:0 0 6px}
    .sendText{
      width:100%;
      min-height:110px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:white;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <div class="badge">‚úì</div>
      <div>
        <h1>Cl√≠nica ‚Äî Check-in Semanal (Pacientes + Importa√ß√£o)</h1>
        <div class="sub">
          Cole o <b>c√≥digo CHK1</b> que o paciente mandou (WhatsApp) ou importe o <b>JSON</b>. O registro entra direto no hist√≥rico e no gr√°fico.
        </div>
      </div>
    </div>
    <div class="btns">
      <button class="ghost" id="btnExportDB">Exportar Banco (JSON)</button>
      <button class="ghost" id="btnImportDB">Importar Banco (JSON)</button>
      <button class="warn" id="btnWipeAll">Apagar tudo (geral)</button>
      <input type="file" id="fileImportDB" accept="application/json" style="display:none"/>
    </div>
  </header>

  <div class="layout">
    <!-- LEFT -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-end">
        <div>
          <div style="font-weight:1000">Pacientes</div>
          <div class="muted small">Buscar por nome, ID ou telefone</div>
        </div>
        <div class="btns">
          <button class="primary" id="btnNewPatient">+ Novo</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <input type="text" id="patientSearch" placeholder="Buscar: Maria, P-0003, 99999..."/>
      </div>

      <div class="pActive" id="activePatientBox">
        <div class="name" id="activeName">Nenhum paciente selecionado</div>
        <div class="meta" id="activeMeta">Crie ou selecione um paciente.</div>
      </div>

      <!-- NEW: message to send patient -->
      <div class="sendBox">
        <div class="sendTitle">Mensagem para enviar ao paciente (WhatsApp)</div>
        <div class="muted small">Selecione o paciente e clique em ‚ÄúCopiar mensagem‚Äù. Depois anexe o arquivo <b>paciente_checkin.html</b>.</div>
        <div class="divider"></div>
        <div class="sendText" id="sendText" aria-label="Mensagem pronta">Selecione um paciente para gerar a mensagem.</div>
        <div class="btns" style="margin-top:10px">
          <button class="ok" id="btnCopyMsg">Copiar mensagem</button>
          <button class="ghost" id="btnRefreshMsg">Atualizar</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div><label>ID do paciente</label><input type="text" id="p_id" placeholder="(auto) ex.: P-0001"/></div>
        <div><label>Nome</label><input type="text" id="p_name" placeholder="Nome do paciente"/></div>
        <div><label>Telefone (opcional)</label><input type="tel" id="p_phone" placeholder="(xx) xxxxx-xxxx"/></div>
        <div><label>Observa√ß√£o (opcional)</label><input type="text" id="p_note" placeholder="ex.: 15 anos, escola X"/></div>

        <div class="btns">
          <button class="ok" id="btnSavePatient">Salvar</button>
          <button class="ghost" id="btnClearPatient">Limpar</button>
          <button class="warn" id="btnDeletePatient">Excluir</button>
        </div>
      </div>

      <div style="margin-top:12px" class="pList" id="patientList"></div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="grid">
          <div class="row" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end">
            <div style="min-width:240px">
              <label>Data do check-in</label>
              <input type="date" id="data"/>
            </div>
            <div style="flex:1 1 auto"></div>
            <div class="btns">
              <button class="ghost" id="btnLoadLatest">Carregar √∫ltimo (aba)</button>
              <button class="primary" id="btnSave">Salvar semana (aba)</button>
              <button class="ghost" id="btnClear">Limpar aba</button>
              <button class="warn" id="btnDelete">Apagar esta data</button>
            </div>
          </div>

          <!-- IMPORT AREA -->
          <div class="card" style="margin-top:0; background:linear-gradient(135deg,var(--softBlue),#fff)">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-end">
              <div>
                <div style="font-weight:1000">Importar do paciente</div>
                <div class="muted small">Cole o c√≥digo <span class="mono">CHK1...</span> ou importe o JSON enviado.</div>
              </div>
              <div class="btns">
                <button class="ghost" id="btnImportJSON">Importar JSON</button>
                <input type="file" id="fileImportJSON" accept="application/json" style="display:none"/>
                <button class="ok" id="btnImportCode">Importar c√≥digo</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>C√≥digo do WhatsApp</label>
              <textarea id="codeInput" placeholder="Cole aqui o c√≥digo CHK1. ...."></textarea>
            </div>
            <div class="muted small" id="importHint" style="margin-top:8px">
              Dica: se o paciente n√£o informou ID, o sistema tenta achar pelo nome; se n√£o achar, cria um paciente novo.
            </div>
          </div>

          <div class="tabs" id="tabs"></div>
          <div class="muted small" id="hintSelect">Selecione um paciente para come√ßar.</div>
        </div>
      </div>

      <div class="two">
        <div class="card">
          <div id="emotionHeader" style="display:none"></div>
          <div class="grid" id="questions"></div>

          <div class="scorebar">
            <div class="score">
              <div class="muted small" id="scoreRange">Pontua√ß√£o total</div>
              <div class="big" id="total">‚Äî</div>
            </div>
            <div class="pill" id="msg"><i></i><span>Responda tudo para ver o resultado</span></div>
          </div>

          <div style="margin-top:10px">
            <label>Anota√ß√£o da semana (opcional)</label>
            <textarea id="nota"></textarea>
          </div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="box"><div class="v" id="kpiLast">‚Äî</div><div class="t">√öltima pontua√ß√£o</div></div>
            <div class="box"><div class="v" id="kpiBest">‚Äî</div><div class="t">Melhor (8 semanas)</div></div>
            <div class="box"><div class="v" id="kpiTrend">‚Äî</div><div class="t">Tend√™ncia (4 semanas)</div></div>
          </div>

          <div style="margin-top:12px">
            <label>Gr√°fico (aba atual)</label>
            <canvas id="chart" width="900" height="360"></canvas>
            <div class="minihelp" id="helpText">Selecione um paciente.</div>
          </div>

          <div style="margin-top:12px" class="btns">
            <button class="ok" id="btnExportPatient">Exportar Paciente (JSON)</button>
            <button class="ghost" id="btnExportCSV">Exportar CSV (paciente)</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-end">
          <div>
            <h2 style="margin:0; font-size:16px">Hist√≥rico ‚Äî aba atual</h2>
            <div class="muted small">Clique numa linha para carregar.</div>
          </div>
        </div>

        <div class="tablewrap" style="margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="width:140px">Data</th>
                <th style="width:110px" class="right">Total</th>
                <th style="width:110px" class="right">M√©dia</th>
                <th style="width:220px">Emo√ß√£o (se aplic√°vel)</th>
                <th>Anota√ß√£o</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="muted small" style="margin-top:10px">
          Armazenamento: localStorage. Use Exportar para backup.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const DB_KEY = "clinic_checkin_db_v2_import";

  const SCALES = {
    ansiedade: { id:"ansiedade", label:"Ansiedade", icon:"A", direction:"down_is_better",
      help:"Quanto mais baixo, melhor (menos ansiedade).",
      questions:[
        { id:"q1", title:"Com que frequ√™ncia voc√™ ficou ansioso(a)?", text:"Na √∫ltima semana, quantas vezes a ansiedade apareceu?",
          options:["0 ‚Äî N√£o fiquei ansioso(a).","1 ‚Äî Algumas vezes.","2 ‚Äî V√°rias vezes.","3 ‚Äî Quase todo dia.","4 ‚Äî O tempo todo."] },
        { id:"q2", title:"Quando veio, qu√£o forte foi a ansiedade?", text:"Quanto ela subiu no corpo e na cabe√ßa?",
          options:["0 ‚Äî Muito leve.","1 ‚Äî Leve.","2 ‚Äî M√©dia.","3 ‚Äî Forte.","4 ‚Äî Muito forte."] },
        { id:"q3", title:"Voc√™ evitou coisas por causa da ansiedade/medo?", text:"Ex.: escola, sair, falar, apresentar.",
          options:["0 ‚Äî N√£o evitei.","1 ‚Äî Poucas vezes.","2 ‚Äî Algumas coisas.","3 ‚Äî Evitei bastante.","4 ‚Äî Evitei quase tudo."] },
        { id:"q4", title:"Quanto isso atrapalhou suas obriga√ß√µes?", text:"Escola, tarefas, casa, compromissos.",
          options:["0 ‚Äî N√£o atrapalhou.","1 ‚Äî Um pouco.","2 ‚Äî Atrapalhou.","3 ‚Äî Atrapalhou muito.","4 ‚Äî Travou geral."] },
        { id:"q5", title:"Quanto isso atrapalhou seus relacionamentos?", text:"Amigos, fam√≠lia, mensagens.",
          options:["0 ‚Äî N√£o atrapalhou.","1 ‚Äî Um pouco.","2 ‚Äî Atrapalhou.","3 ‚Äî Atrapalhou muito.","4 ‚Äî Atrapalhou demais."] },
      ],
      message:(t)=> t<=4?{t:"Semana leve.",c:"var(--emerald)"}:t<=8?{t:"Semana ok.",c:"var(--blue)"}:t<=12?{t:"Semana puxada.",c:"var(--amber)"}:{t:"Semana dif√≠cil.",c:"var(--rose)"}
    },
    depressao: { id:"depressao", label:"Depress√£o", icon:"D", direction:"down_is_better",
      help:"Quanto mais baixo, melhor (menos peso/depress√£o).",
      questions:[
        { id:"q1", title:"Humor para baixo", text:"Quanto voc√™ ficou triste/vazio(a)?",
          options:["0 ‚Äî Quase nunca.","1 ‚Äî Algumas vezes.","2 ‚Äî V√°rias vezes.","3 ‚Äî Quase todo dia.","4 ‚Äî O tempo todo."] },
        { id:"q2", title:"Energia", text:"Como ficou sua energia para fazer as coisas?",
          options:["0 ‚Äî Ok.","1 ‚Äî Um pouco menos.","2 ‚Äî Baixa.","3 ‚Äî Muito baixa.","4 ‚Äî Quase zero."] },
        { id:"q3", title:"Interesse/prazer", text:"Conseguiu curtir algo?",
          options:["0 ‚Äî Normal.","1 ‚Äî Um pouco menos.","2 ‚Äî Bem menos.","3 ‚Äî Quase nada.","4 ‚Äî Nada."] },
        { id:"q4", title:"Sono/corpo", text:"Sono/cansa√ßo atrapalharam?",
          options:["0 ‚Äî N√£o.","1 ‚Äî Um pouco.","2 ‚Äî Atrapalhou.","3 ‚Äî Muito.","4 ‚Äî Demais."] },
        { id:"q5", title:"Pensamentos negativos", text:"Quanto vieram pensamentos tipo ‚Äún√£o vai melhorar‚Äù?",
          options:["0 ‚Äî Quase n√£o.","1 ‚Äî Algumas vezes.","2 ‚Äî Bastante.","3 ‚Äî Muito.","4 ‚Äî O tempo todo."] },
      ],
      message:(t)=> t<=4?{t:"Mais leve.",c:"var(--emerald)"}:t<=8?{t:"Ok.",c:"var(--blue)"}:t<=12?{t:"Puxado.",c:"var(--amber)"}:{t:"Dif√≠cil.",c:"var(--rose)"}
    },
    emocao: { id:"emocao", label:"Outra emo√ß√£o", icon:"E", direction:"down_is_better", hasEmotionName:true,
      help:"Escolha a emo√ß√£o e responda sobre ela. Quanto mais baixo, melhor.",
      questions:[
        { id:"q1", title:"Frequ√™ncia", text:"Com que frequ√™ncia sentiu essa emo√ß√£o?",
          options:["0 ‚Äî Quase nunca.","1 ‚Äî Algumas vezes.","2 ‚Äî V√°rias vezes.","3 ‚Äî Quase todo dia.","4 ‚Äî O tempo todo."] },
        { id:"q2", title:"Intensidade", text:"Quando veio, qu√£o forte foi?",
          options:["0 ‚Äî Leve.","1 ‚Äî Leve.","2 ‚Äî M√©dia.","3 ‚Äî Forte.","4 ‚Äî Muito forte."] },
        { id:"q3", title:"Controle", text:"Quanto foi dif√≠cil segurar (impulso)?",
          options:["0 ‚Äî Tranquilo.","1 ‚Äî Um pouco.","2 ‚Äî Dif√≠cil.","3 ‚Äî Muito dif√≠cil.","4 ‚Äî Quase imposs√≠vel."] },
        { id:"q4", title:"Obriga√ß√µes", text:"Quanto atrapalhou rotina/escola?",
          options:["0 ‚Äî N√£o.","1 ‚Äî Um pouco.","2 ‚Äî Atrapalhou.","3 ‚Äî Muito.","4 ‚Äî Travou."] },
        { id:"q5", title:"Rela√ß√µes", text:"Quanto atrapalhou amigos/fam√≠lia?",
          options:["0 ‚Äî N√£o.","1 ‚Äî Um pouco.","2 ‚Äî Atrapalhou.","3 ‚Äî Muito.","4 ‚Äî Demais."] },
      ],
      message:(t)=> t<=4?{t:"Manej√°vel.",c:"var(--emerald)"}:t<=8?{t:"Ok.",c:"var(--blue)"}:t<=12?{t:"Puxado.",c:"var(--amber)"}:{t:"Dif√≠cil.",c:"var(--rose)"}
    },
    positivas: { id:"positivas", label:"Positivas", icon:"P", direction:"up_is_better",
      help:"Aqui √© o contr√°rio: quanto MAIS alto, melhor (mais positivos).",
      questions:[
        { id:"q1", title:"Alegria/leveza", text:"Quanto teve momentos de alegria/leveza?",
          options:["0 ‚Äî Nada.","1 ‚Äî Pouco.","2 ‚Äî Um pouco.","3 ‚Äî Bastante.","4 ‚Äî Muito."] },
        { id:"q2", title:"Calma/seguran√ßa", text:"Quanto conseguiu sentir calma/seguran√ßa?",
          options:["0 ‚Äî Nada.","1 ‚Äî Pouco.","2 ‚Äî Um pouco.","3 ‚Äî Bastante.","4 ‚Äî Muito."] },
        { id:"q3", title:"Orgulho", text:"Quanto sentiu orgulho de algo que fez?",
          options:["0 ‚Äî Nada.","1 ‚Äî Pouco.","2 ‚Äî Um pouco.","3 ‚Äî Bastante.","4 ‚Äî Muito."] },
        { id:"q4", title:"Conex√£o", text:"Quanto se sentiu conectado(a) com algu√©m?",
          options:["0 ‚Äî Nada.","1 ‚Äî Pouco.","2 ‚Äî Um pouco.","3 ‚Äî Bastante.","4 ‚Äî Muito."] },
        { id:"q5", title:"Energia", text:"Quanto teve energia/motiva√ß√£o?",
          options:["0 ‚Äî Nada.","1 ‚Äî Pouco.","2 ‚Äî Um pouco.","3 ‚Äî Bastante.","4 ‚Äî Muito."] },
      ],
      message:(t)=> t<=4?{t:"Baixo (precisa construir).",c:"var(--rose)"}:t<=8?{t:"Subindo.",c:"var(--amber)"}:t<=12?{t:"Bom.",c:"var(--blue)"}:{t:"Muito bom.",c:"var(--emerald)"}
    },
  };
  const TAB_ORDER = ["ansiedade","depressao","emocao","positivas"];

  let currentScaleId = "ansiedade";
  let activePatientId = null;

  const $ = (id)=>document.getElementById(id);

  const elTabs = $("tabs");
  const elQuestions = $("questions");
  const elTotal = $("total");
  const elMsg = $("msg");
  const elData = $("data");
  const elNota = $("nota");
  const elTbody = $("tbody");
  const elKpiLast = $("kpiLast");
  const elKpiBest = $("kpiBest");
  const elKpiTrend = $("kpiTrend");
  const elHelpText = $("helpText");
  const elScoreRange = $("scoreRange");
  const elEmotionHeader = $("emotionHeader");
  const elHintSelect = $("hintSelect");

  const elPatientSearch = $("patientSearch");
  const elPatientList = $("patientList");
  const elActiveName = $("activeName");
  const elActiveMeta = $("activeMeta");
  const elPId = $("p_id");
  const elPName = $("p_name");
  const elPPhone = $("p_phone");
  const elPNote = $("p_note");

  const elCodeInput = $("codeInput");

  // NEW: message box
  const elSendText = $("sendText");
  const btnCopyMsg = $("btnCopyMsg");
  const btnRefreshMsg = $("btnRefreshMsg");

  const todayISO = new Date().toISOString().slice(0,10);
  elData.value = todayISO;

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function readDB(){
    try{
      const db = JSON.parse(localStorage.getItem(DB_KEY) || "{}");
      if(!db.patients) db.patients = {};
      if(!db.data) db.data = {};
      return db;
    }catch(e){
      return {patients:{}, data:{}};
    }
  }
  function writeDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

  function ensurePatientData(db, pid){
    if(!db.data[pid]) db.data[pid] = {};
    TAB_ORDER.forEach(sid => { if(!db.data[pid][sid]) db.data[pid][sid] = {}; });
  }

  function genNextPatientId(db){
    let max = 0;
    Object.keys(db.patients||{}).forEach(id=>{
      const m = String(id).match(/^P-(\d+)$/);
      if(m) max = Math.max(max, Number(m[1]));
    });
    return "P-" + String(max+1).padStart(4,"0");
  }

  function normalizeName(s){
    return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
  }

  function findPatientByName(db, name){
    const target = normalizeName(name);
    if(!target) return null;
    for(const p of Object.values(db.patients||{})){
      if(normalizeName(p.name) === target) return p.id;
    }
    return null;
  }

  // NEW: message generator
  function buildPatientMessage(){
    if(!activePatientId){
      elSendText.textContent = "Selecione um paciente para gerar a mensagem.";
      return;
    }
    const db = readDB();
    const p = db.patients[activePatientId];
    const nm = p?.name ? p.name : "seu";
    const pid = p?.id ? p.id : activePatientId;

    const msg =
`Oi ${nm}! üòä

Vamos fazer seu check-in semanal rapidinho (leva 1‚Äì2 min).

‚úÖ Seu ID √©: ${pid}

1) Abra o arquivo: paciente_checkin.html
2) Se for a primeira vez: preencha ID + nome e clique ‚ÄúSalvar meus dados‚Äù.
3) Responda as 5 perguntas da escala da semana.
4) No final clique ‚ÄúCopiar c√≥digo‚Äù e me envie aqui no WhatsApp.

Se preferir, voc√™ tamb√©m pode clicar ‚ÄúBaixar JSON‚Äù e mandar o arquivo.

Obrigada!`;
    elSendText.textContent = msg;
  }

  async function copyTextToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      alert("Mensagem copiada ‚úÖ Cole no WhatsApp.");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Mensagem copiada ‚úÖ Cole no WhatsApp.");
    }
  }

  function setActivePatient(pid){
    const db = readDB();
    if(!db.patients[pid]) return;
    activePatientId = pid;
    db.active_patient_id = pid;
    ensurePatientData(db, pid);
    writeDB(db);

    const p = db.patients[pid];
    elActiveName.textContent = p.name || "(sem nome)";
    elActiveMeta.textContent = `${p.id} ‚Ä¢ ${p.phone ? p.phone + " ‚Ä¢ " : ""}${p.note || ""}`.trim();

    elPId.value = p.id || "";
    elPName.value = p.name || "";
    elPPhone.value = p.phone || "";
    elPNote.value = p.note || "";

    elHintSelect.textContent = `Paciente ativo: ${p.name || "(sem nome)"} (${p.id})`;

    buildPatientMessage(); // NEW

    buildTabs();
    buildQuestions();
    refreshScore();
    renderAll();
    tryLoadCurrentDate();
    renderPatientList();
  }

  function renderPatientList(){
    const db = readDB();
    const q = (elPatientSearch.value || "").trim().toLowerCase();
    const list = Object.values(db.patients||{})
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
      .filter(p=>{
        if(!q) return true;
        return `${p.id} ${p.name||""} ${p.phone||""}`.toLowerCase().includes(q);
      });
    elPatientList.innerHTML = "";
    if(list.length===0){
      elPatientList.innerHTML = `<div class="pRow"><div><div class="nm">Nenhum paciente</div><div class="id">Clique em ‚Äú+ Novo‚Äù.</div></div></div>`;
      buildPatientMessage();
      return;
    }
    list.forEach(p=>{
      const row = document.createElement("div");
      row.className = "pRow";
      row.innerHTML = `
        <div>
          <div class="nm">${escapeHTML(p.name||"(sem nome)")}</div>
          <div class="id">${escapeHTML(p.id)}${p.phone ? " ‚Ä¢ "+escapeHTML(p.phone) : ""}</div>
        </div>
        <div class="tag ${p.id===activePatientId ? "active" : ""}">${p.id===activePatientId ? "ATIVO" : "Selecionar"}</div>
      `;
      row.addEventListener("click", ()=>setActivePatient(p.id));
      elPatientList.appendChild(row);
    });
    buildPatientMessage();
  }

  function clearPatientEditor(){
    elPId.value=""; elPName.value=""; elPPhone.value=""; elPNote.value="";
  }

  function savePatient(){
    const db = readDB();
    let pid = (elPId.value||"").trim();
    const name = (elPName.value||"").trim();
    if(!name){ alert("Informe o NOME do paciente."); return; }
    if(!pid){ pid = genNextPatientId(db); elPId.value = pid; }
    if(!/^P-\d{4}$/.test(pid)){
      alert("ID inv√°lido. Use P-0001 (ou deixe vazio para auto).");
      return;
    }
    const now = new Date().toISOString();
    const existed = !!db.patients[pid];
    db.patients[pid] = {
      id: pid,
      name,
      phone: (elPPhone.value||"").trim(),
      note: (elPNote.value||"").trim(),
      created_at: existed ? (db.patients[pid].created_at || now) : now,
      updated_at: now
    };
    ensurePatientData(db, pid);
    writeDB(db);
    setActivePatient(pid);
    renderPatientList();
  }

  function deletePatient(){
    const pid = (elPId.value||"").trim();
    if(!pid){ alert("Selecione um paciente."); return; }
    const db = readDB();
    if(!db.patients[pid]){ alert("Paciente n√£o encontrado."); return; }
    if(confirm(`Excluir ${db.patients[pid].name} (${pid}) e TODOS os dados?`)){
      delete db.patients[pid];
      delete db.data[pid];
      if(db.active_patient_id===pid) db.active_patient_id = null;
      writeDB(db);

      activePatientId = null;
      clearPatientEditor();
      elActiveName.textContent = "Nenhum paciente selecionado";
      elActiveMeta.textContent = "Crie ou selecione um paciente.";
      elHintSelect.textContent = "Selecione um paciente para come√ßar.";

      buildPatientMessage(); // NEW

      buildTabs(); buildQuestions(); refreshScore(); renderAll();
      renderPatientList();
    }
  }

  function patientBucket(){
    if(!activePatientId) return null;
    const db = readDB();
    ensurePatientData(db, activePatientId);
    writeDB(db);
    return db.data[activePatientId];
  }

  function buildTabs(){
    elTabs.innerHTML = "";
    TAB_ORDER.forEach(id=>{
      const s = SCALES[id];
      const b = document.createElement("button");
      b.className = "tab" + (id===currentScaleId ? " active" : "");
      b.type = "button";
      b.innerHTML = `<span class="ico">${s.icon}</span> ${s.label}`;
      b.addEventListener("click", ()=>{
        currentScaleId = id;
        elTabs.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        buildQuestions();
        refreshScore();
        renderAll();
        tryLoadCurrentDate();
      });
      elTabs.appendChild(b);
    });
  }

  function buildEmotionHeaderIfNeeded(){
    const scale = SCALES[currentScaleId];
    if(!scale.hasEmotionName){
      elEmotionHeader.style.display="none";
      elEmotionHeader.innerHTML="";
      return;
    }
    elEmotionHeader.style.display="block";
    elEmotionHeader.innerHTML = `
      <div class="emotionLine">
        <div style="min-width:240px">
          <label>EMO√á√ÉO: ______</label>
          <input type="text" id="emotionName" placeholder="ex.: raiva / ci√∫mes / vergonha" />
        </div>
        <div class="muted small">A chave salva como: <span class="mono">DATA|emo√ß√£o</span></div>
      </div>
    `;
    document.getElementById("emotionName").addEventListener("input", ()=>{
      tryLoadCurrentDate();
      renderAll();
    });
  }
  function getEmotionName(){
    const i = document.getElementById("emotionName");
    return i ? i.value : "";
  }
  function setEmotionName(v){
    const i = document.getElementById("emotionName");
    if(i) i.value = v || "";
  }

  function buildQuestions(){
    const scale = SCALES[currentScaleId];
    buildEmotionHeaderIfNeeded();

    elQuestions.innerHTML = "";
    scale.questions.forEach((q, idx)=>{
      const wrap = document.createElement("div");
      wrap.className = "q";
      wrap.innerHTML = `
        <div class="qhead">
          <div style="display:flex; gap:10px; align-items:flex-start">
            <div class="qnum">${idx+1}</div>
            <div>
              <p class="qtitle">${escapeHTML(q.title)}</p>
              <div class="qtext">${escapeHTML(q.text)}</div>
            </div>
          </div>
          <div class="muted small">0‚Äì4</div>
        </div>
        <div class="choices" id="choices_${q.id}"></div>
      `;
      elQuestions.appendChild(wrap);
      const choices = wrap.querySelector(`#choices_${q.id}`);
      q.options.forEach((txt, val)=>{
        const opt = document.createElement("label");
        opt.className = "choice";
        opt.innerHTML = `<input type="radio" name="${q.id}" value="${val}"/><div>${escapeHTML(txt)}</div>`;
        choices.appendChild(opt);
      });
    });

    elScoreRange.textContent = `Pontua√ß√£o total (0 a ${scale.questions.length*4})`;
    elHelpText.textContent = activePatientId ? scale.help : "Selecione um paciente.";
    elQuestions.querySelectorAll('input[type="radio"]').forEach(r=> r.addEventListener("change", refreshScore));
  }

  function getAnswers(){
    const scale = SCALES[currentScaleId];
    const ans = {};
    let ok = true;
    scale.questions.forEach(q=>{
      const c = document.querySelector(`input[name="${q.id}"]:checked`);
      if(!c) ok = false;
      ans[q.id] = c ? Number(c.value) : null;
    });
    return {ans, complete: ok};
  }
  function computeTotal(ans){
    const scale = SCALES[currentScaleId];
    return scale.questions.reduce((sum,q)=> sum + (ans[q.id] ?? 0), 0);
  }
  function refreshScore(){
    if(!activePatientId){
      elTotal.textContent="‚Äî";
      elMsg.querySelector("span").textContent="Selecione um paciente";
      elMsg.querySelector("i").style.background="var(--blue)";
      return;
    }
    const {ans, complete} = getAnswers();
    if(!complete){
      elTotal.textContent="‚Äî";
      elMsg.querySelector("span").textContent="Responda tudo para ver o resultado";
      elMsg.querySelector("i").style.background="var(--blue)";
      return;
    }
    const total = computeTotal(ans);
    elTotal.textContent = String(total);
    const m = SCALES[currentScaleId].message(total);
    elMsg.querySelector("span").textContent = m.t;
    elMsg.querySelector("i").style.background = m.c;
  }

  function makeKey(scaleId, date){
    if(scaleId!=="emocao") return date;
    const emo = (getEmotionName()||"").trim().toLowerCase();
    return date + "|" + (emo || "‚Äî");
  }

  function clearCurrentForm(keepEmotion=true){
    SCALES[currentScaleId].questions.forEach(q=>{
      document.querySelectorAll(`input[name="${q.id}"]`).forEach(r=> r.checked=false);
    });
    elNota.value="";
    if(currentScaleId==="emocao" && !keepEmotion) setEmotionName("");
    refreshScore();
  }

  function collectRecord(){
    if(!activePatientId) return {error:"Selecione um paciente."};
    const date = (elData.value||"").trim();
    if(!date) return {error:"Selecione a data."};
    if(SCALES[currentScaleId].hasEmotionName){
      const emo = (getEmotionName()||"").trim();
      if(!emo) return {error:"Preencha EMO√á√ÉO."};
    }
    const {ans, complete} = getAnswers();
    if(!complete) return {error:"Responda tudo antes de salvar."};
    const total = computeTotal(ans);
    const rec = {
      v: 1,
      date,
      patient_id: activePatientId,
      scale: currentScaleId,
      emotion: SCALES[currentScaleId].hasEmotionName ? (getEmotionName()||"").trim() : null,
      answers: ans,
      total,
      note: (elNota.value||"").trim(),
      updated_at: new Date().toISOString()
    };
    return {rec};
  }

  function saveCurrent(){
    const got = collectRecord();
    if(got.error){ alert(got.error); return; }
    const db = readDB();
    ensurePatientData(db, activePatientId);
    const key = makeKey(currentScaleId, got.rec.date);
    db.data[activePatientId][currentScaleId][key] = got.rec;
    writeDB(db);
    renderAll();
    alert("Salvo ‚úÖ");
  }

  function deleteCurrent(){
    if(!activePatientId){ alert("Selecione um paciente."); return; }
    const date = (elData.value||"").trim();
    if(!date){ alert("Selecione a data."); return; }
    if(SCALES[currentScaleId].hasEmotionName && !(getEmotionName()||"").trim()){
      alert("Preencha EMO√á√ÉO para apagar o registro certo.");
      return;
    }
    const key = makeKey(currentScaleId, date);
    const db = readDB();
    ensurePatientData(db, activePatientId);
    if(db.data[activePatientId][currentScaleId][key]){
      if(confirm("Apagar este registro? ("+key+")")){
        delete db.data[activePatientId][currentScaleId][key];
        writeDB(db);
        renderAll();
      }
    } else {
      alert("N√£o encontrei registro para esta data (nesta aba).");
    }
  }

  function tryLoadCurrentDate(){
    if(!activePatientId){ clearCurrentForm(true); return false; }
    const date = (elData.value||"").trim();
    if(!date) return false;

    const db = readDB();
    ensurePatientData(db, activePatientId);
    const bucket = db.data[activePatientId][currentScaleId] || {};
    const key = makeKey(currentScaleId, date);
    const rec = bucket[key];
    if(!rec){ clearCurrentForm(true); return false; }

    elNota.value = rec.note || "";
    if(SCALES[currentScaleId].hasEmotionName) setEmotionName(rec.emotion || "");

    SCALES[currentScaleId].questions.forEach(q=>{
      document.querySelectorAll(`input[name="${q.id}"]`).forEach(r=> r.checked=false);
      const v = rec.answers?.[q.id];
      if(v === 0 || v){
        const radio = document.querySelector(`input[name="${q.id}"][value="${v}"]`);
        if(radio) radio.checked = true;
      }
    });
    refreshScore();
    return true;
  }

  function loadLatestForScale(){
    if(!activePatientId){ alert("Selecione um paciente."); return; }
    const db = readDB();
    ensurePatientData(db, activePatientId);
    const bucket = db.data[activePatientId][currentScaleId] || {};
    const keys = Object.keys(bucket).sort();
    if(keys.length===0){ alert("Sem registros nesta aba."); return; }
    const lastKey = keys[keys.length-1];
    const rec = bucket[lastKey];
    elData.value = rec.date || todayISO;
    if(SCALES[currentScaleId].hasEmotionName) setEmotionName(rec.emotion || "");
    tryLoadCurrentDate();
  }

  function getRecordsForScale(){
    if(!activePatientId) return [];
    const db = readDB();
    ensurePatientData(db, activePatientId);
    const bucket = db.data[activePatientId][currentScaleId] || {};
    return Object.entries(bucket).map(([k,v])=>({key:k, ...v})).sort((a,b)=>a.key.localeCompare(b.key));
  }

  function renderTable(){
    const arr = getRecordsForScale();
    const scale = SCALES[currentScaleId];
    const nQ = scale.questions.length;
    elTbody.innerHTML = "";

    if(!activePatientId){
      elTbody.innerHTML = `<tr><td colspan="5" class="muted small">Selecione um paciente para ver o hist√≥rico.</td></tr>`;
      return;
    }

    arr.slice().reverse().forEach(rec=>{
      const avg = ((rec.total ?? 0)/nQ).toFixed(1);
      const emo = rec.emotion ? rec.emotion : "‚Äî";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><button class="ghost small" style="padding:6px 10px; border-radius:10px; border:1px solid var(--border); cursor:pointer" data-key="${escapeHTML(rec.key)}">${rec.date}</button></td>
        <td class="right"><b>${rec.total ?? 0}</b></td>
        <td class="right">${avg}</td>
        <td class="small">${scale.hasEmotionName ? escapeHTML(emo) : "‚Äî"}</td>
        <td class="small">${escapeHTML(rec.note || "")}</td>
      `;
      elTbody.appendChild(tr);
    });

    elTbody.querySelectorAll("button[data-key]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const k = b.dataset.key;
        const db = readDB();
        ensurePatientData(db, activePatientId);
        const rec = (db.data[activePatientId][currentScaleId]||{})[k];
        if(!rec) return;
        elData.value = rec.date || todayISO;
        if(SCALES[currentScaleId].hasEmotionName) setEmotionName(rec.emotion || "");
        tryLoadCurrentDate();
        window.scrollTo({top:0, behavior:"smooth"});
      });
    });
  }

  function calcKPIs(){
    const arr = getRecordsForScale();
    const scale = SCALES[currentScaleId];
    if(!activePatientId || arr.length===0){
      elKpiLast.textContent="‚Äî"; elKpiBest.textContent="‚Äî"; elKpiTrend.textContent="‚Äî";
      return;
    }
    const last = arr[arr.length-1];
    elKpiLast.textContent = String(last.total ?? "‚Äî");
    const last8 = arr.slice(Math.max(0, arr.length-8)).map(x=>x.total ?? 0);
    const best = (scale.direction==="down_is_better") ? Math.min(...last8) : Math.max(...last8);
    elKpiBest.textContent = String(best);

    const last4 = arr.slice(Math.max(0, arr.length-4));
    if(last4.length>=2){
      const first = last4[0].total ?? 0;
      const lastv = last4[last4.length-1].total ?? 0;
      const diff = lastv - first;
      let arrow;
      if(scale.direction==="down_is_better"){
        arrow = diff<0 ? "‚Üò (melhora)" : diff>0 ? "‚Üó (piorou)" : "‚Üí (est√°vel)";
      } else {
        arrow = diff>0 ? "‚Üó (melhora)" : diff<0 ? "‚Üò (caiu)" : "‚Üí (est√°vel)";
      }
      elKpiTrend.textContent = `${arrow} ${diff===0?"":(Math.abs(diff)+" pts")}`.trim();
    } else {
      elKpiTrend.textContent="‚Äî";
    }
  }

  function drawChart(){
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const padL=56, padR=18, padT=18, padB=46;
    const W=canvas.width, H=canvas.height;
    const plotW=W-padL-padR, plotH=H-padT-padB;

    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);

    if(!activePatientId){
      ctx.fillStyle="#64748b";
      ctx.font="14px ui-sans-serif, system-ui";
      ctx.fillText("Selecione um paciente para ver o gr√°fico.", padL, padT+22);
      return;
    }

    const scale = SCALES[currentScaleId];
    const dataAll = getRecordsForScale();
    const data = dataAll.slice(Math.max(0, dataAll.length-12));
    const maxY = scale.questions.length*4;

    ctx.strokeStyle="#e2e8f0"; ctx.lineWidth=1;
    const step = Math.max(2, Math.floor(maxY/5));
    for(let v=0; v<=maxY; v+=step){
      const y = padT + (maxY - v) * (plotH / maxY);
      ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
      ctx.fillStyle="#64748b"; ctx.font="12px ui-sans-serif, system-ui";
      ctx.fillText(String(v), 18, y+4);
    }

    if(data.length===0){
      ctx.fillStyle="#64748b"; ctx.font="14px ui-sans-serif, system-ui";
      ctx.fillText("Sem dados nesta aba. Importe ou salve a 1¬™ semana.", padL, padT+22);
      return;
    }

    const n=data.length;
    const xAt=(i)=> padL + (n===1 ? plotW/2 : i*(plotW/(n-1)));
    const yAt=(val)=> padT + (maxY - val)*(plotH/maxY);

    ctx.strokeStyle="#2563eb"; ctx.lineWidth=3;
    ctx.beginPath();
    data.forEach((r,i)=>{
      const x=xAt(i), y=yAt(r.total ?? 0);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    data.forEach((r,i)=>{
      const x=xAt(i), y=yAt(r.total ?? 0);
      ctx.fillStyle="#8b5cf6";
      ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
      const d = (r.date||"").slice(5);
      ctx.fillStyle="#64748b"; ctx.font="11px ui-sans-serif, system-ui";
      ctx.fillText(d, x-14, H-22);
    });

    ctx.fillStyle="#0f172a"; ctx.font="12px ui-sans-serif, system-ui";
    ctx.fillText(`Pontua√ß√£o total (0‚Äì${maxY})`, padL, 14);
  }

  function renderAll(){
    renderTable(); calcKPIs(); drawChart();
  }

  // ===== IMPORT (CODE + JSON) =====
  function base64urlDecodeToString(b64url){
    let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
    while(b64.length % 4) b64 += "=";
    const str = atob(b64);
    return decodeURIComponent(escape(str));
  }

  function validatePayload(p){
    if(!p || typeof p !== "object") return "Payload inv√°lido.";
    if(!p.date || !/^\d{4}-\d{2}-\d{2}$/.test(p.date)) return "Data inv√°lida.";
    if(!p.scale || !SCALES[p.scale]) return "Escala inv√°lida.";
    if(!p.answers || typeof p.answers !== "object") return "Respostas inv√°lidas.";
    for(let i=1;i<=5;i++){
      const k = "q"+i;
      const v = p.answers[k];
      if(typeof v !== "number" || v<0 || v>4) return "Respostas incompletas/fora do padr√£o (q1..q5).";
    }
    if(p.scale==="emocao"){
      if(!p.emotion || !String(p.emotion).trim()) return "Faltou EMO√á√ÉO.";
    }
    return null;
  }

  function upsertFromPayload(payload){
    const err = validatePayload(payload);
    if(err){ alert("Importa√ß√£o falhou: " + err); return; }

    const db = readDB();

    let pid = (payload.patient_id || "").trim();
    const pname = (payload.patient_name || "").trim();

    if(pid && !db.patients[pid]){
      db.patients[pid] = {
        id: pid,
        name: pname || pid,
        phone: "",
        note: "Criado via importa√ß√£o",
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
    }

    if(!pid){
      const found = findPatientByName(db, pname);
      if(found) pid = found;
    }

    if(!pid){
      pid = genNextPatientId(db);
      db.patients[pid] = {
        id: pid,
        name: pname || ("Paciente " + pid),
        phone: "",
        note: "Criado via importa√ß√£o",
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
    }

    ensurePatientData(db, pid);

    const scaleId = payload.scale;
    const key = (scaleId==="emocao")
      ? (payload.date + "|" + String(payload.emotion||"").trim().toLowerCase())
      : payload.date;

    const rec = {
      v: 1,
      date: payload.date,
      patient_id: pid,
      scale: scaleId,
      emotion: (scaleId==="emocao") ? String(payload.emotion||"").trim() : null,
      answers: payload.answers,
      total: (typeof payload.total==="number") ? payload.total : Object.values(payload.answers).reduce((a,b)=>a+(b??0),0),
      note: String(payload.note||"").trim(),
      updated_at: new Date().toISOString(),
      imported_at: new Date().toISOString()
    };
    db.data[pid][scaleId][key] = rec;

    db.active_patient_id = pid;
    writeDB(db);

    setActivePatient(pid);
    currentScaleId = scaleId;
    buildTabs();
    buildQuestions();

    elData.value = payload.date;
    if(scaleId==="emocao") setEmotionName(rec.emotion || "");
    tryLoadCurrentDate();
    renderAll();

    alert(`Importado ‚úÖ (${pid} ‚Ä¢ ${payload.date} ‚Ä¢ ${SCALES[scaleId].label}${scaleId==="emocao" ? " ‚Ä¢ "+rec.emotion : ""})`);
  }

  function importFromCode(text){
    const t = String(text||"").trim();
    if(!t.startsWith("CHK1.")){ alert("C√≥digo inv√°lido. Precisa come√ßar com CHK1."); return; }
    const b64url = t.slice(5).trim();
    try{
      const json = base64urlDecodeToString(b64url);
      const payload = JSON.parse(json);
      upsertFromPayload(payload);
    }catch(e){
      alert("Falha ao ler o c√≥digo: " + e.message);
    }
  }

  function importFromJSONFile(file){
    const r = new FileReader();
    r.onload = () => {
      try{
        const payload = JSON.parse(r.result);
        upsertFromPayload(payload);
      }catch(e){
        alert("Falha ao importar JSON: " + e.message);
      }
    };
    r.readAsText(file);
  }

  // ===== EXPORTS / DB =====
  function downloadText(filename, text, mime){
    const blob = new Blob([text], {type: mime || "application/octet-stream"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportDB(){
    const db = readDB();
    downloadText("banco_checkin_pacientes.json", JSON.stringify(db, null, 2), "application/json");
  }

  function importDBFile(file){
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        if(!data || typeof data !== "object") throw new Error("JSON inv√°lido.");
        if(!data.patients) data.patients = {};
        if(!data.data) data.data = {};

        const current = readDB();
        const merged = {
          patients: {...current.patients, ...data.patients},
          data: {...current.data, ...data.data},
          active_patient_id: data.active_patient_id || current.active_patient_id || null
        };
        writeDB(merged);

        renderPatientList();
        if(merged.active_patient_id && merged.patients[merged.active_patient_id]){
          setActivePatient(merged.active_patient_id);
        } else {
          activePatientId = null;
          buildTabs(); buildQuestions(); refreshScore(); renderAll();
        }
        alert("Banco importado ‚úÖ");
      }catch(e){
        alert("Falha ao importar banco: " + e.message);
      }
    };
    r.readAsText(file);
  }

  function exportActivePatient(){
    if(!activePatientId){ alert("Selecione um paciente."); return; }
    const db = readDB();
    const pack = {
      patient: db.patients[activePatientId],
      data: db.data[activePatientId] || {},
      exported_at: new Date().toISOString()
    };
    downloadText(`paciente_${activePatientId}.json`, JSON.stringify(pack, null, 2), "application/json");
  }

  function exportPatientCSV(){
    if(!activePatientId){ alert("Selecione um paciente."); return; }
    const db = readDB();
    ensurePatientData(db, activePatientId);
    const pdata = db.data[activePatientId];

    const header = ["patient_id","scale","key","date","emotion","total","q1","q2","q3","q4","q5","note"].join(",");
    const lines = [];
    TAB_ORDER.forEach(scaleId=>{
      const bucket = pdata[scaleId] || {};
      Object.entries(bucket).forEach(([key, rec])=>{
        const safe = (s)=> `"${String(s ?? "").replaceAll('"','""')}"`;
        const a = rec.answers || {};
        lines.push([
          safe(activePatientId), safe(scaleId), safe(key), rec.date||"",
          safe(rec.emotion||""), rec.total ?? "",
          a.q1 ?? "", a.q2 ?? "", a.q3 ?? "", a.q4 ?? "", a.q5 ?? "",
          safe(rec.note||"")
        ].join(","));
      });
    });
    downloadText(`paciente_${activePatientId}_historico.csv`, [header, ...lines].join("\n"), "text/csv;charset=utf-8");
  }

  function wipeAll(){
    if(confirm("Isso apaga TODO o banco neste navegador. Tem certeza?")){
      localStorage.removeItem(DB_KEY);
      activePatientId = null;
      clearPatientEditor();
      renderPatientList();
      buildTabs(); buildQuestions(); refreshScore(); renderAll();
      elActiveName.textContent="Nenhum paciente selecionado";
      elActiveMeta.textContent="Crie ou selecione um paciente.";
      elHintSelect.textContent="Selecione um paciente para come√ßar.";
      buildPatientMessage();
    }
  }

  // ===== Wiring UI =====
  $("btnNewPatient").addEventListener("click", ()=>{
    const db = readDB();
    clearPatientEditor();
    $("p_id").value = genNextPatientId(db);
    $("p_name").focus();
  });
  $("btnSavePatient").addEventListener("click", savePatient);
  $("btnClearPatient").addEventListener("click", clearPatientEditor);
  $("btnDeletePatient").addEventListener("click", deletePatient);
  elPatientSearch.addEventListener("input", renderPatientList);

  $("btnSave").addEventListener("click", saveCurrent);
  $("btnLoadLatest").addEventListener("click", loadLatestForScale);
  $("btnClear").addEventListener("click", ()=>clearCurrentForm(true));
  $("btnDelete").addEventListener("click", deleteCurrent);
  elData.addEventListener("change", ()=>{ tryLoadCurrentDate(); renderAll(); });

  $("btnExportPatient").addEventListener("click", exportActivePatient);
  $("btnExportCSV").addEventListener("click", exportPatientCSV);

  $("btnExportDB").addEventListener("click", exportDB);
  $("btnImportDB").addEventListener("click", ()=>$("fileImportDB").click());
  $("fileImportDB").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importDBFile(f);
    e.target.value = "";
  });
  $("btnWipeAll").addEventListener("click", wipeAll);

  $("btnImportJSON").addEventListener("click", ()=>$("fileImportJSON").click());
  $("fileImportJSON").addEventListener("change", (e)=>{
    const f = e.target.files?.[0];
    if(f) importFromJSONFile(f);
    e.target.value = "";
  });
  $("btnImportCode").addEventListener("click", ()=>{
    importFromCode(elCodeInput.value);
    elCodeInput.value = "";
  });

  // NEW message buttons
  btnCopyMsg.addEventListener("click", ()=>{
    copyTextToClipboard(elSendText.textContent || "");
  });
  btnRefreshMsg.addEventListener("click", buildPatientMessage);

  // ===== INIT =====
  buildTabs();
  buildQuestions();
  refreshScore();
  renderAll();
  renderPatientList();
  buildPatientMessage();

  const db0 = readDB();
  if(db0.active_patient_id && db0.patients[db0.active_patient_id]){
    setActivePatient(db0.active_patient_id);
  } else {
    elHelpText.textContent = "Selecione um paciente.";
  }
})();
</script>
</body>
</html>
